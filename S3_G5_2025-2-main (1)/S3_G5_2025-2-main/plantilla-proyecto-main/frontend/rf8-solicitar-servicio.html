<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RF8 - Solicitar Servicio - AlpesCab</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <a href="index.html" class="back-button">‚Üê Volver al Men√∫</a>
    
    <div class="container">
        <div class="header">
            <h1>üöï RF8 - Solicitar Servicio</h1>
            <p>Solicitar servicios de transporte con asignaci√≥n autom√°tica de conductores</p>
        </div>
        
        <div class="content">
            <!-- Informaci√≥n del Proceso -->
            <div class="alert alert-info">
                <h4>üîç Proceso de Solicitud de Servicio (RF8)</h4>
                <ol>
                    <li><strong>Verificar medio de pago:</strong> El usuario debe tener una tarjeta de cr√©dito registrada</li>
                    <li><strong>Buscar conductor disponible:</strong> Se busca un conductor cerca que tenga disponibilidad</li>
                    <li><strong>Asignar conductor autom√°ticamente:</strong> Se asigna el primer conductor disponible</li>
                    <li><strong>Calcular tarifa:</strong> Se calcula el costo basado en distancia y nivel de transporte</li>
                    <li><strong>Registrar inicio del viaje:</strong> Se guarda la hora de inicio y datos del servicio</li>
                </ol>
            </div>
            
            <!-- Secci√≥n: Solicitar Servicio -->
            <div class="form-section">
                <h2>üìù Solicitar Nuevo Servicio</h2>
                <form id="solicitarServicioForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_servicio">ID Servicio *</label>
                            <input type="number" id="id_servicio" name="id_servicio" required placeholder="Ej: 1001" min="1">
                        </div>
                        <div class="form-group">
                            <label for="id_usuario_servicio">C√©dula Usuario Solicitante *</label>
                            <input type="number" id="id_usuario_servicio" name="id_usuario_servicio" required placeholder="C√©dula del usuario" min="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="distancia_km">Distancia (km) *</label>
                            <input type="number" id="distancia_km" name="distancia_km" required step="0.1" min="0.1" placeholder="Ej: 5.5">
                        </div>
                        <div class="form-group">
                            <label for="id_tipo_servicio">Tipo de Servicio *</label>
                            <select id="id_tipo_servicio" name="id_tipo_servicio" required>
                                <option value="">Seleccione tipo de servicio...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_punto_origen">ID Punto de Origen *</label>
                            <input type="number" id="id_punto_origen" name="id_punto_origen" required placeholder="ID origen" min="1">
                        </div>
                        <div class="form-group">
                            <label for="id_punto_destino">ID Punto de Destino *</label>
                            <input type="number" id="id_punto_destino" name="id_punto_destino" required placeholder="ID destino" min="1">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">üöó Solicitar Servicio</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm('solicitarServicioForm')">Limpiar</button>
                </form>
            </div>
            
            <!-- RESPUESTA - Mensaje de √âxito (ARRIBA) -->
            <div class="results-section" id="respuesta-box" style="display: none;">
                <h3>‚úÖ RESPUESTA</h3>
                <div id="respuesta-content"></div>
            </div>
            
            <!-- Secci√≥n: Buscar Conductores Disponibles -->
            <div class="form-section">
                <h2>üöó Buscar Conductores Disponibles</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="dia_buscar_cond">D√≠a de la Semana *</label>
                        <select id="dia_buscar_cond" required>
                            <option value="">-- Selecciona un d√≠a --</option>
                            <option value="1">Lunes (1)</option>
                            <option value="2">Martes (2)</option>
                            <option value="3">Mi√©rcoles (3)</option>
                            <option value="4">Jueves (4)</option>
                            <option value="5">Viernes (5)</option>
                            <option value="6">S√°bado (6)</option>
                            <option value="7">Domingo (7)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hora_inicio_buscar">Hora Inicio *</label>
                        <input type="time" id="hora_inicio_buscar" required>
                    </div>
                    <div class="form-group">
                        <label for="hora_fin_buscar">Hora Fin *</label>
                        <input type="time" id="hora_fin_buscar" required>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="verificarConductoresDisponibles()">Ver Conductores</button>
            </div>
            
            <!-- Resultados de Conductores -->
            <div class="results-section">
                <h3>üìã Resultados</h3>
                <div id="results"></div>
            </div>
        </div>
    </div>
    
    <script src="js/common.js"></script>
    <script>
        let conductorAsignado = null;
        
        // Cargar tipos de servicio
        window.addEventListener('load', async function() {
            try {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const dia = dayOfWeek === 0 ? 7 : dayOfWeek;
                
                document.getElementById('dia_buscar_cond').value = dia;
                document.getElementById('hora_inicio_buscar').value = '08:00';
                document.getElementById('hora_fin_buscar').value = '17:00';
                
                // Cargar tipos de servicio
                const tiposServicio = await get('/tiposServicio/darTiposServicio');
                const selectTipo = document.getElementById('id_tipo_servicio');
                tiposServicio.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id_tipo_servicio;
                    option.textContent = `${tipo.nombre} (${tipo.id_tipo_servicio})`;
                    selectTipo.appendChild(option);
                });
            } catch (error) {
                console.error('Error en carga inicial:', error);
            }
        });
        
        // Solicitar servicio
        document.getElementById('solicitarServicioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Intentando solicitar servicio. conductorAsignado:', conductorAsignado);
            
            const respuestaBox = document.getElementById('respuesta-box');
            const respuestaContent = document.getElementById('respuesta-content');
            
            if (!validateForm('solicitarServicioForm')) {
                respuestaContent.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; color: #721c24; border-radius: 5px; border-left: 4px solid #dc3545;">
                        <h4 style="margin: 0 0 10px 0;">‚ùå Error - Campos Incompletos</h4>
                        <p style="margin: 0;">Por favor complete todos los campos del formulario.</p>
                    </div>
                `;
                respuestaBox.style.display = 'block';
                return;
            }
            
            if (!conductorAsignado) {
                respuestaContent.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; color: #856404; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <h4 style="margin: 0 0 10px 0;">‚ö†Ô∏è Advertencia</h4>
                        <p style="margin: 0;">No hay conductores disponibles. Por favor haz clic en "Ver Conductores" primero para buscar conductores disponibles.</p>
                    </div>
                `;
                respuestaBox.style.display = 'block';
                return;
            }
            
            const formData = new FormData(this);
            const params = new URLSearchParams();
            for (let [key, value] of formData.entries()) {
                params.append(key, value);
            }
            params.append('id_conductor', conductorAsignado);
            
            console.log('Par√°metros a enviar:', params.toString());
            
            try {
                // Mostrar un mensaje de carga
                respuestaContent.innerHTML = `<p style="text-align: center;">üîÑ Procesando solicitud...</p>`;
                respuestaBox.style.display = 'block';
                
                const result = await post(`/servicios/solicitarAuto?${params}`);
                
                // Mostrar resultado en el cuadro RESPUESTA
                respuestaContent.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; color: #155724; border-radius: 5px; border-left: 4px solid #28a745;">
                        <h4 style="margin: 0 0 10px 0;">‚úÖ Servicio Creado Exitosamente</h4>
                        <p style="margin: 0;"><strong>Conductor Asignado:</strong> ${conductorAsignado}</p>
                    </div>
                `;
                respuestaBox.style.display = 'block';
                
                resetForm('solicitarServicioForm');
                conductorAsignado = null;
            } catch (error) {
                respuestaContent.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; color: #721c24; border-radius: 5px; border-left: 4px solid #dc3545;">
                        <h4 style="margin: 0 0 10px 0;">‚ùå Error en la Creaci√≥n del Servicio</h4>
                        <p style="margin: 0;"><strong>Motivo:</strong> ${error.message}</p>
                    </div>
                `;
                respuestaBox.style.display = 'block';
            }
        });
        
        // Verificar conductores disponibles
        async function verificarConductoresDisponibles() {
            const dia = document.getElementById('dia_buscar_cond').value;
            const hora_inicio_str = document.getElementById('hora_inicio_buscar').value;
            const hora_fin_str = document.getElementById('hora_fin_buscar').value;
            
            if (!dia || !hora_inicio_str || !hora_fin_str) {
                showResult('Complete los campos de b√∫squeda.', true);
                return;
            }
            
            try {
                const disponibilidades = await get('/disponibilidades/darDisponibilidades');
                
                const [hi, mi] = hora_inicio_str.split(':');
                const [hf, mf] = hora_fin_str.split(':');
                const search_start = parseInt(hi) * 60 + parseInt(mi);
                const search_end = parseInt(hf) * 60 + parseInt(mf);
                
                const disponibles = disponibilidades.filter(disp => {
                    if (parseInt(disp.dia_semana) !== parseInt(dia)) return false;
                    
                    const disp_start_date = new Date(disp.hora_inicio);
                    const disp_end_date = new Date(disp.hora_fin);
                    
                    const disp_start = disp_start_date.getHours() * 60 + disp_start_date.getMinutes();
                    const disp_end = disp_end_date.getHours() * 60 + disp_end_date.getMinutes();
                    
                    return disp_start <= search_start && search_end <= disp_end;
                });
                
                const resultsDiv = document.getElementById('results');
                
                if (disponibles.length > 0) {
                    // Guardar el conductor asignado (el primero disponible)
                    if (disponibles[0].usuario?.cedula) {
                        conductorAsignado = disponibles[0].usuario.cedula;
                    } else if (disponibles[0].id_usuario_conductor) {
                        conductorAsignado = disponibles[0].id_usuario_conductor;
                    }
                    console.log('Conductor asignado:', conductorAsignado);
                    console.log('Disponibles:', disponibles);
                    
                    let html = `<h4>üöó Conductores Disponibles (${disponibles.length})</h4>
                                <table border="1" style="width:100%; border-collapse:collapse; margin-top:10px;">
                                    <tr style="background-color:#007bff; color:white;">
                                        <th style="padding:10px;">C√©dula</th>
                                        <th style="padding:10px;">Nombre</th>
                                        <th style="padding:10px;">Hora Inicio</th>
                                        <th style="padding:10px;">Hora Fin</th>
                                    </tr>`;
                    
                    disponibles.forEach((disp, index) => {
                        const horaInicio = new Date(disp.hora_inicio).toLocaleTimeString('es-CO', {hour: '2-digit', minute:'2-digit'});
                        const horaFin = new Date(disp.hora_fin).toLocaleTimeString('es-CO', {hour: '2-digit', minute:'2-digit'});
                        html += `<tr style="border-bottom:1px solid #ddd;">
                                    <td style="padding:10px;">${disp.usuario?.cedula}</td>
                                    <td style="padding:10px;">${disp.usuario?.nombre}</td>
                                    <td style="padding:10px;">${horaInicio}</td>
                                    <td style="padding:10px;">${horaFin}</td>
                                </tr>`;
                    });
                    
                    html += '</table>';
                    resultsDiv.innerHTML = html;
                } else {
                    conductorAsignado = null;
                    resultsDiv.innerHTML = `<p style="background: #f8d7da; padding: 10px; color: #721c24;">‚ö†Ô∏è No hay conductores disponibles</p>`;
                }
            } catch (error) {
                showResult(`Error: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
